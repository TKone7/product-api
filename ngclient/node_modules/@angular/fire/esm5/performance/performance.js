/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, NgZone, ApplicationRef, InjectionToken, Inject, Optional, PLATFORM_ID } from '@angular/core';
import { Observable, of, empty } from 'rxjs';
import { first, tap, map, shareReplay, switchMap } from 'rxjs/operators';
import { FirebaseApp, ÉµlazySDKProxy } from '@angular/fire';
import { isPlatformBrowser } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
// SEMVER @ v6, drop and move core ng metrics to a service
/** @type {?} */
export var AUTOMATICALLY_TRACE_CORE_NG_METRICS = new InjectionToken('angularfire2.performance.auto_trace');
/** @type {?} */
export var INSTRUMENTATION_ENABLED = new InjectionToken('angularfire2.performance.instrumentationEnabled');
/** @type {?} */
export var DATA_COLLECTION_ENABLED = new InjectionToken('angularfire2.performance.dataCollectionEnabled');
// WARNING: interface has both a type and a value, skipping emit
;
var AngularFirePerformance = /** @class */ (function () {
    function AngularFirePerformance(app, automaticallyTraceCoreNgMetrics, instrumentationEnabled, dataCollectionEnabled, appRef, zone, platformId) {
        var _this = this;
        this.zone = zone;
        this.trace$ = (/**
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        function (name, options) {
            return _this.performance.pipe(switchMap((/**
             * @param {?} performance
             * @return {?}
             */
            function (performance) {
                return new Observable((/**
                 * @param {?} emitter
                 * @return {?}
                 */
                function (emitter) {
                    return _this.zone.runOutsideAngular((/**
                     * @return {?}
                     */
                    function () {
                        /** @type {?} */
                        var trace = performance.trace(name);
                        options && options.metrics && Object.keys(options.metrics).forEach((/**
                         * @param {?} metric
                         * @return {?}
                         */
                        function (metric) {
                            trace.putMetric(metric, (/** @type {?} */ ((/** @type {?} */ (options)).metrics))[metric]);
                        }));
                        options && options.attributes && Object.keys(options.attributes).forEach((/**
                         * @param {?} attribute
                         * @return {?}
                         */
                        function (attribute) {
                            trace.putAttribute(attribute, (/** @type {?} */ ((/** @type {?} */ (options)).attributes))[attribute]);
                        }));
                        /** @type {?} */
                        var attributeSubscriptions = options && options.attribute$ ? Object.keys(options.attribute$).map((/**
                         * @param {?} attribute
                         * @return {?}
                         */
                        function (attribute) {
                            return (/** @type {?} */ ((/** @type {?} */ (options)).attribute$))[attribute].subscribe((/**
                             * @param {?} next
                             * @return {?}
                             */
                            function (next) { return trace.putAttribute(attribute, next); }));
                        })) : [];
                        /** @type {?} */
                        var metricSubscriptions = options && options.metric$ ? Object.keys(options.metric$).map((/**
                         * @param {?} metric
                         * @return {?}
                         */
                        function (metric) {
                            return (/** @type {?} */ ((/** @type {?} */ (options)).metric$))[metric].subscribe((/**
                             * @param {?} next
                             * @return {?}
                             */
                            function (next) { return trace.putMetric(metric, next); }));
                        })) : [];
                        /** @type {?} */
                        var incrementOnSubscriptions = options && options.incrementMetric$ ? Object.keys(options.incrementMetric$).map((/**
                         * @param {?} metric
                         * @return {?}
                         */
                        function (metric) {
                            return (/** @type {?} */ ((/** @type {?} */ (options)).incrementMetric$))[metric].subscribe((/**
                             * @param {?} next
                             * @return {?}
                             */
                            function (next) { return trace.incrementMetric(metric, next || undefined); }));
                        })) : [];
                        emitter.next(trace.start());
                        return { unsubscribe: (/**
                             * @return {?}
                             */
                            function () {
                                trace.stop();
                                metricSubscriptions.forEach((/**
                                 * @param {?} m
                                 * @return {?}
                                 */
                                function (m) { return m.unsubscribe(); }));
                                incrementOnSubscriptions.forEach((/**
                                 * @param {?} m
                                 * @return {?}
                                 */
                                function (m) { return m.unsubscribe(); }));
                                attributeSubscriptions.forEach((/**
                                 * @param {?} m
                                 * @return {?}
                                 */
                                function (m) { return m.unsubscribe(); }));
                            }) };
                    }));
                }));
            })));
        });
        this.traceUntil = (/**
         * @template T
         * @param {?} name
         * @param {?} test
         * @param {?=} options
         * @return {?}
         */
        function (name, test, options) { return (/**
         * @param {?} source$
         * @return {?}
         */
        function (source$) { return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        function (subscriber) {
            /** @type {?} */
            var traceSubscription = _this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @param {?} a
             * @return {?}
             */
            function (a) { return test(a) && traceSubscription.unsubscribe(); }), (/**
             * @return {?}
             */
            function () { }), (/**
             * @return {?}
             */
            function () { return options && options.orComplete && traceSubscription.unsubscribe(); }))).subscribe(subscriber);
        })); }); });
        this.traceWhile = (/**
         * @template T
         * @param {?} name
         * @param {?} test
         * @param {?=} options
         * @return {?}
         */
        function (name, test, options) { return (/**
         * @param {?} source$
         * @return {?}
         */
        function (source$) { return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        function (subscriber) {
            /** @type {?} */
            var traceSubscription;
            return source$.pipe(tap((/**
             * @param {?} a
             * @return {?}
             */
            function (a) {
                if (test(a)) {
                    traceSubscription = traceSubscription || _this.trace$(name, options).subscribe();
                }
                else {
                    traceSubscription && traceSubscription.unsubscribe();
                    traceSubscription = undefined;
                }
            }), (/**
             * @return {?}
             */
            function () { }), (/**
             * @return {?}
             */
            function () { return options && options.orComplete && traceSubscription && traceSubscription.unsubscribe(); }))).subscribe(subscriber);
        })); }); });
        this.traceUntilComplete = (/**
         * @template T
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        function (name, options) { return (/**
         * @param {?} source$
         * @return {?}
         */
        function (source$) { return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        function (subscriber) {
            /** @type {?} */
            var traceSubscription = _this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @return {?}
             */
            function () { }), (/**
             * @return {?}
             */
            function () { }), (/**
             * @return {?}
             */
            function () { return traceSubscription.unsubscribe(); }))).subscribe(subscriber);
        })); }); });
        this.traceUntilFirst = (/**
         * @template T
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        function (name, options) { return (/**
         * @param {?} source$
         * @return {?}
         */
        function (source$) { return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        function (subscriber) {
            /** @type {?} */
            var traceSubscription = _this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @return {?}
             */
            function () { return traceSubscription.unsubscribe(); }), (/**
             * @return {?}
             */
            function () { }), (/**
             * @return {?}
             */
            function () { }))).subscribe(subscriber);
        })); }); });
        this.trace = (/**
         * @template T
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        function (name, options) { return (/**
         * @param {?} source$
         * @return {?}
         */
        function (source$) { return new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        function (subscriber) {
            /** @type {?} */
            var traceSubscription = _this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @return {?}
             */
            function () { return traceSubscription.unsubscribe(); }), (/**
             * @return {?}
             */
            function () { }), (/**
             * @return {?}
             */
            function () { return traceSubscription.unsubscribe(); }))).subscribe(subscriber);
        })); }); });
        this.performance = of(undefined).pipe(switchMap((/**
         * @return {?}
         */
        function () { return isPlatformBrowser(platformId) ? zone.runOutsideAngular((/**
         * @return {?}
         */
        function () { return import('firebase/performance'); })) : empty(); })), map((/**
         * @return {?}
         */
        function () { return zone.runOutsideAngular((/**
         * @return {?}
         */
        function () { return app.performance(); })); })), tap((/**
         * @param {?} performance
         * @return {?}
         */
        function (performance) {
            if (instrumentationEnabled == false) {
                performance.instrumentationEnabled = false;
            }
            if (dataCollectionEnabled == false) {
                performance.dataCollectionEnabled = false;
            }
        })), shareReplay({ bufferSize: 1, refCount: false }));
        if (automaticallyTraceCoreNgMetrics != false) {
            // TODO determine more built in metrics
            // this leaks... move to a service?
            appRef.isStable.pipe(first((/**
             * @param {?} it
             * @return {?}
             */
            function (it) { return it; })), this.traceUntilComplete('isStable')).subscribe();
        }
        return ÉµlazySDKProxy(this, this.performance, zone);
    }
    AngularFirePerformance.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'any'
                },] }
    ];
    /** @nocollapse */
    AngularFirePerformance.ctorParameters = function () { return [
        { type: FirebaseApp },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [AUTOMATICALLY_TRACE_CORE_NG_METRICS,] }] },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [INSTRUMENTATION_ENABLED,] }] },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [DATA_COLLECTION_ENABLED,] }] },
        { type: ApplicationRef },
        { type: NgZone },
        { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
    ]; };
    /** @nocollapse */ AngularFirePerformance.Éµprov = i0.ÉµÉµdefineInjectable({ factory: function AngularFirePerformance_Factory() { return new AngularFirePerformance(i0.ÉµÉµinject(i1.FirebaseApp), i0.ÉµÉµinject(AUTOMATICALLY_TRACE_CORE_NG_METRICS, 8), i0.ÉµÉµinject(INSTRUMENTATION_ENABLED, 8), i0.ÉµÉµinject(DATA_COLLECTION_ENABLED, 8), i0.ÉµÉµinject(i0.ApplicationRef), i0.ÉµÉµinject(i0.NgZone), i0.ÉµÉµinject(i0.PLATFORM_ID)); }, token: AngularFirePerformance, providedIn: "any" });
    return AngularFirePerformance;
}());
export { AngularFirePerformance };
if (false) {
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.performance;
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.trace$;
    /** @type {?} */
    AngularFirePerformance.prototype.traceUntil;
    /** @type {?} */
    AngularFirePerformance.prototype.traceWhile;
    /** @type {?} */
    AngularFirePerformance.prototype.traceUntilComplete;
    /** @type {?} */
    AngularFirePerformance.prototype.traceUntilFirst;
    /** @type {?} */
    AngularFirePerformance.prototype.trace;
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyZm9ybWFuY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci9maXJlL3BlcmZvcm1hbmNlLyIsInNvdXJjZXMiOlsicGVyZm9ybWFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEgsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpFLE9BQU8sRUFBRSxXQUFXLEVBQWlCLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7QUFHcEQsTUFBTSxLQUFPLG1DQUFtQyxHQUFHLElBQUksY0FBYyxDQUFVLHFDQUFxQyxDQUFDOztBQUNySCxNQUFNLEtBQU8sdUJBQXVCLEdBQUcsSUFBSSxjQUFjLENBQVUsaURBQWlELENBQUM7O0FBQ3JILE1BQU0sS0FBTyx1QkFBdUIsR0FBRyxJQUFJLGNBQWMsQ0FBVSxnREFBZ0QsQ0FBQzs7QUFFWixDQUFDO0FBVXpHO0lBT0UsZ0NBQ0UsR0FBZ0IsRUFDeUMsK0JBQTRDLEVBQ3hELHNCQUFtQyxFQUNuQyxxQkFBa0MsRUFDL0UsTUFBc0IsRUFDZCxJQUFZLEVBQ0MsVUFBaUI7UUFQeEMsaUJBaUNDO1FBM0JTLFNBQUksR0FBSixJQUFJLENBQVE7UUE2QkwsV0FBTTs7Ozs7UUFBRyxVQUFDLElBQVcsRUFBRSxPQUFzQjtZQUM1RCxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUNuQixTQUFTOzs7O1lBQUMsVUFBQSxX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LFNBQUMsdUJBQXVCO2dCQWpDbEIsY0FBYztnQkFBdEIsTUFBTTtnQkFvQ1MsTUFBTSx1QkFBckMsTUFBTSxTQUFDLFdBQVc7OztpQ0FwQ3ZCO0NBK0pDLEFBeklELElBeUlDO1NBdElZLHNCQUFzQjs7Ozs7O0lBRWpDLDZDQUFrRTs7Ozs7SUFxQ2xFLHdDQStCSTs7SUFFSiw0Q0FTRzs7SUFFSCw0Q0FnQkc7O0lBRUgsb0RBU0c7O0lBRUgsaURBU0c7O0lBRUgsdUNBU0c7Ozs7O0lBMUhELHNDQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSwgQXBwbGljYXRpb25SZWYsIEluamVjdGlvblRva2VuLCBJbmplY3QsIE9wdGlvbmFsLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCBvZiwgZW1wdHkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpcnN0LCB0YXAsIG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IHBlcmZvcm1hbmNlIH0gZnJvbSAnZmlyZWJhc2UvYXBwJztcbmltcG9ydCB7IEZpcmViYXNlQXBwLCDJtVByb21pc2VQcm94eSwgybVsYXp5U0RLUHJveHkgfSBmcm9tICdAYW5ndWxhci9maXJlJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuLy8gU0VNVkVSIEAgdjYsIGRyb3AgYW5kIG1vdmUgY29yZSBuZyBtZXRyaWNzIHRvIGEgc2VydmljZVxuZXhwb3J0IGNvbnN0IEFVVE9NQVRJQ0FMTFlfVFJBQ0VfQ09SRV9OR19NRVRSSUNTID0gbmV3IEluamVjdGlvblRva2VuPGJvb2xlYW4+KCdhbmd1bGFyZmlyZTIucGVyZm9ybWFuY2UuYXV0b190cmFjZScpO1xuZXhwb3J0IGNvbnN0IElOU1RSVU1FTlRBVElPTl9FTkFCTEVEID0gbmV3IEluamVjdGlvblRva2VuPGJvb2xlYW4+KCdhbmd1bGFyZmlyZTIucGVyZm9ybWFuY2UuaW5zdHJ1bWVudGF0aW9uRW5hYmxlZCcpO1xuZXhwb3J0IGNvbnN0IERBVEFfQ09MTEVDVElPTl9FTkFCTEVEID0gbmV3IEluamVjdGlvblRva2VuPGJvb2xlYW4+KCdhbmd1bGFyZmlyZTIucGVyZm9ybWFuY2UuZGF0YUNvbGxlY3Rpb25FbmFibGVkJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQW5ndWxhckZpcmVQZXJmb3JtYW5jZSBleHRlbmRzIE9taXQ8ybVQcm9taXNlUHJveHk8cGVyZm9ybWFuY2UuUGVyZm9ybWFuY2U+LCAndHJhY2UnPiB7fTtcblxuZXhwb3J0IHR5cGUgVHJhY2VPcHRpb25zID0ge1xuICBtZXRyaWNzPzoge1trZXk6c3RyaW5nXTogbnVtYmVyfSxcbiAgYXR0cmlidXRlcz86IHtba2V5OnN0cmluZ106c3RyaW5nfSxcbiAgYXR0cmlidXRlJD86IHtba2V5OnN0cmluZ106T2JzZXJ2YWJsZTxzdHJpbmc+fSxcbiAgaW5jcmVtZW50TWV0cmljJD86IHtba2V5OnN0cmluZ106IE9ic2VydmFibGU8bnVtYmVyfHZvaWR8bnVsbHx1bmRlZmluZWQ+fSxcbiAgbWV0cmljJD86IHtba2V5OnN0cmluZ106IE9ic2VydmFibGU8bnVtYmVyPn1cbn07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ2FueSdcbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhckZpcmVQZXJmb3JtYW5jZSB7XG4gIFxuICBwcml2YXRlIHJlYWRvbmx5IHBlcmZvcm1hbmNlOiBPYnNlcnZhYmxlPHBlcmZvcm1hbmNlLlBlcmZvcm1hbmNlPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IEZpcmViYXNlQXBwLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoQVVUT01BVElDQUxMWV9UUkFDRV9DT1JFX05HX01FVFJJQ1MpIGF1dG9tYXRpY2FsbHlUcmFjZUNvcmVOZ01ldHJpY3M6Ym9vbGVhbnxudWxsLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSU5TVFJVTUVOVEFUSU9OX0VOQUJMRUQpIGluc3RydW1lbnRhdGlvbkVuYWJsZWQ6Ym9vbGVhbnxudWxsLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoREFUQV9DT0xMRUNUSU9OX0VOQUJMRUQpIGRhdGFDb2xsZWN0aW9uRW5hYmxlZDpib29sZWFufG51bGwsXG4gICAgYXBwUmVmOiBBcHBsaWNhdGlvblJlZixcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwbGF0Zm9ybUlkOk9iamVjdFxuICApIHtcblxuICAgIHRoaXMucGVyZm9ybWFuY2UgPSBvZih1bmRlZmluZWQpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gaXNQbGF0Zm9ybUJyb3dzZXIocGxhdGZvcm1JZCkgPyB6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IGltcG9ydCgnZmlyZWJhc2UvcGVyZm9ybWFuY2UnKSkgOiBlbXB0eSgpKSxcbiAgICAgIG1hcCgoKSA9PiB6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IGFwcC5wZXJmb3JtYW5jZSgpKSksXG4gICAgICB0YXAocGVyZm9ybWFuY2UgPT4ge1xuICAgICAgICBpZiAoaW5zdHJ1bWVudGF0aW9uRW5hYmxlZCA9PSBmYWxzZSkgeyBwZXJmb3JtYW5jZS5pbnN0cnVtZW50YXRpb25FbmFibGVkID0gZmFsc2UgfVxuICAgICAgICBpZiAoZGF0YUNvbGxlY3Rpb25FbmFibGVkID09IGZhbHNlKSB7IHBlcmZvcm1hbmNlLmRhdGFDb2xsZWN0aW9uRW5hYmxlZCA9IGZhbHNlIH1cbiAgICAgIH0pLFxuICAgICAgc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogZmFsc2UgfSksXG4gICAgKTtcblxuICAgIGlmIChhdXRvbWF0aWNhbGx5VHJhY2VDb3JlTmdNZXRyaWNzICE9IGZhbHNlKSB7XG5cbiAgICAgIC8vIFRPRE8gZGV0ZXJtaW5lIG1vcmUgYnVpbHQgaW4gbWV0cmljc1xuICAgICAgLy8gdGhpcyBsZWFrcy4uLiBtb3ZlIHRvIGEgc2VydmljZT9cbiAgICAgIGFwcFJlZi5pc1N0YWJsZS5waXBlKFxuICAgICAgICBmaXJzdChpdCA9PiBpdCksXG4gICAgICAgIHRoaXMudHJhY2VVbnRpbENvbXBsZXRlKCdpc1N0YWJsZScpXG4gICAgICApLnN1YnNjcmliZSgpO1xuXG4gICAgfVxuXG4gICAgcmV0dXJuIMm1bGF6eVNES1Byb3h5KHRoaXMsIHRoaXMucGVyZm9ybWFuY2UsIHpvbmUpO1xuXG4gIH1cblxuICBwcml2YXRlIHJlYWRvbmx5IHRyYWNlJCA9IChuYW1lOnN0cmluZywgb3B0aW9ucz86IFRyYWNlT3B0aW9ucykgPT5cbiAgICB0aGlzLnBlcmZvcm1hbmNlLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAocGVyZm9ybWFuY2UgPT5cbiAgICAgICAgbmV3IE9ic2VydmFibGU8dm9pZD4oZW1pdHRlciA9PlxuICAgICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0cmFjZSA9IHBlcmZvcm1hbmNlLnRyYWNlKG5hbWUpO1xuICAgICAgICAgICAgb3B0aW9ucyAmJiBvcHRpb25zLm1ldHJpY3MgJiYgT2JqZWN0LmtleXMob3B0aW9ucy5tZXRyaWNzKS5mb3JFYWNoKG1ldHJpYyA9PiB7XG4gICAgICAgICAgICAgIHRyYWNlLnB1dE1ldHJpYyhtZXRyaWMsIG9wdGlvbnMhLm1ldHJpY3MhW21ldHJpY10pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5hdHRyaWJ1dGVzICYmIE9iamVjdC5rZXlzKG9wdGlvbnMuYXR0cmlidXRlcykuZm9yRWFjaChhdHRyaWJ1dGUgPT4ge1xuICAgICAgICAgICAgICB0cmFjZS5wdXRBdHRyaWJ1dGUoYXR0cmlidXRlLCBvcHRpb25zIS5hdHRyaWJ1dGVzIVthdHRyaWJ1dGVdKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVTdWJzY3JpcHRpb25zID0gb3B0aW9ucyAmJiBvcHRpb25zLmF0dHJpYnV0ZSQgPyBPYmplY3Qua2V5cyhvcHRpb25zLmF0dHJpYnV0ZSQpLm1hcChhdHRyaWJ1dGUgPT5cbiAgICAgICAgICAgICAgb3B0aW9ucyEuYXR0cmlidXRlJCFbYXR0cmlidXRlXS5zdWJzY3JpYmUobmV4dCA9PiB0cmFjZS5wdXRBdHRyaWJ1dGUoYXR0cmlidXRlLCBuZXh0KSlcbiAgICAgICAgICAgICkgOiBbXTtcbiAgICAgICAgICAgIGNvbnN0IG1ldHJpY1N1YnNjcmlwdGlvbnMgPSBvcHRpb25zICYmIG9wdGlvbnMubWV0cmljJCA/IE9iamVjdC5rZXlzKG9wdGlvbnMubWV0cmljJCkubWFwKG1ldHJpYyA9PlxuICAgICAgICAgICAgICBvcHRpb25zIS5tZXRyaWMkIVttZXRyaWNdLnN1YnNjcmliZShuZXh0ID0+IHRyYWNlLnB1dE1ldHJpYyhtZXRyaWMsIG5leHQpKVxuICAgICAgICAgICAgKSA6IFtdO1xuICAgICAgICAgICAgY29uc3QgaW5jcmVtZW50T25TdWJzY3JpcHRpb25zID0gb3B0aW9ucyAmJiBvcHRpb25zLmluY3JlbWVudE1ldHJpYyQgPyBPYmplY3Qua2V5cyhvcHRpb25zLmluY3JlbWVudE1ldHJpYyQpLm1hcChtZXRyaWMgPT5cbiAgICAgICAgICAgICAgb3B0aW9ucyEuaW5jcmVtZW50TWV0cmljJCFbbWV0cmljXS5zdWJzY3JpYmUobmV4dCA9PiB0cmFjZS5pbmNyZW1lbnRNZXRyaWMobWV0cmljLCBuZXh0IHx8IHVuZGVmaW5lZCkpXG4gICAgICAgICAgICApIDogW107XG4gICAgICAgICAgICBlbWl0dGVyLm5leHQodHJhY2Uuc3RhcnQoKSk7XG4gICAgICAgICAgICByZXR1cm4geyB1bnN1YnNjcmliZTogKCkgPT4ge1xuICAgICAgICAgICAgICB0cmFjZS5zdG9wKCk7XG4gICAgICAgICAgICAgIG1ldHJpY1N1YnNjcmlwdGlvbnMuZm9yRWFjaChtID0+IG0udW5zdWJzY3JpYmUoKSk7XG4gICAgICAgICAgICAgIGluY3JlbWVudE9uU3Vic2NyaXB0aW9ucy5mb3JFYWNoKG0gPT4gbS51bnN1YnNjcmliZSgpKTtcbiAgICAgICAgICAgICAgYXR0cmlidXRlU3Vic2NyaXB0aW9ucy5mb3JFYWNoKG0gPT4gbS51bnN1YnNjcmliZSgpKTtcbiAgICAgICAgICAgIH19O1xuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgIClcbiAgICApO1xuXG4gIHB1YmxpYyByZWFkb25seSB0cmFjZVVudGlsID0gPFQ9YW55PihuYW1lOnN0cmluZywgdGVzdDogKGE6VCkgPT4gYm9vbGVhbiwgb3B0aW9ucz86IFRyYWNlT3B0aW9ucyAmIHsgb3JDb21wbGV0ZT86IGJvb2xlYW4gfSkgPT4gKHNvdXJjZSQ6IE9ic2VydmFibGU8VD4pID0+IG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xuICAgIGNvbnN0IHRyYWNlU3Vic2NyaXB0aW9uID0gdGhpcy50cmFjZSQobmFtZSwgb3B0aW9ucykuc3Vic2NyaWJlKCk7XG4gICAgcmV0dXJuIHNvdXJjZSQucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgYSAgPT4gdGVzdChhKSAmJiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpLFxuICAgICAgICAoKSA9PiB7fSxcbiAgICAgICAgKCkgPT4gb3B0aW9ucyAmJiBvcHRpb25zLm9yQ29tcGxldGUgJiYgdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgICAgKVxuICAgICkuc3Vic2NyaWJlKHN1YnNjcmliZXIpO1xuICB9KTtcblxuICBwdWJsaWMgcmVhZG9ubHkgdHJhY2VXaGlsZSA9IDxUPWFueT4obmFtZTpzdHJpbmcsIHRlc3Q6IChhOlQpID0+IGJvb2xlYW4sIG9wdGlvbnM/OiBUcmFjZU9wdGlvbnMgJiB7IG9yQ29tcGxldGU/OiBib29sZWFufSkgPT4gKHNvdXJjZSQ6IE9ic2VydmFibGU8VD4pID0+IG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xuICAgIGxldCB0cmFjZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9ufHVuZGVmaW5lZDtcbiAgICByZXR1cm4gc291cmNlJC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICBhICA9PiB7XG4gICAgICAgICAgaWYgKHRlc3QoYSkpIHtcbiAgICAgICAgICAgIHRyYWNlU3Vic2NyaXB0aW9uID0gdHJhY2VTdWJzY3JpcHRpb24gfHwgdGhpcy50cmFjZSQobmFtZSwgb3B0aW9ucykuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRyYWNlU3Vic2NyaXB0aW9uICYmIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB0cmFjZVN1YnNjcmlwdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgICgpID0+IHt9LFxuICAgICAgICAoKSA9PiBvcHRpb25zICYmIG9wdGlvbnMub3JDb21wbGV0ZSAmJiB0cmFjZVN1YnNjcmlwdGlvbiAmJiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgICApXG4gICAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gIH0pO1xuXG4gIHB1YmxpYyByZWFkb25seSB0cmFjZVVudGlsQ29tcGxldGUgPSA8VD1hbnk+KG5hbWU6c3RyaW5nLCBvcHRpb25zPzogVHJhY2VPcHRpb25zKSA9PiAoc291cmNlJDogT2JzZXJ2YWJsZTxUPikgPT4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgY29uc3QgdHJhY2VTdWJzY3JpcHRpb24gPSB0aGlzLnRyYWNlJChuYW1lLCBvcHRpb25zKS5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gc291cmNlJC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7fSxcbiAgICAgICAgKCkgPT4ge30sXG4gICAgICAgICgpID0+IHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKClcbiAgICAgIClcbiAgICApLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgfSk7XG5cbiAgcHVibGljIHJlYWRvbmx5IHRyYWNlVW50aWxGaXJzdCA9IDxUPWFueT4obmFtZTpzdHJpbmcsIG9wdGlvbnM/OiBUcmFjZU9wdGlvbnMpID0+IChzb3VyY2UkOiBPYnNlcnZhYmxlPFQ+KSA9PiBuZXcgT2JzZXJ2YWJsZTxUPihzdWJzY3JpYmVyID0+IHtcbiAgICBjb25zdCB0cmFjZVN1YnNjcmlwdGlvbiA9IHRoaXMudHJhY2UkKG5hbWUsIG9wdGlvbnMpLnN1YnNjcmliZSgpO1xuICAgIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgICgpID0+IHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCksXG4gICAgICAgICgpID0+IHt9LFxuICAgICAgICAoKSA9PiB7fVxuICAgICAgKVxuICAgICkuc3Vic2NyaWJlKHN1YnNjcmliZXIpO1xuICB9KTtcblxuICBwdWJsaWMgcmVhZG9ubHkgdHJhY2UgPSA8VD1hbnk+KG5hbWU6c3RyaW5nLCBvcHRpb25zPzogVHJhY2VPcHRpb25zKSA9PiAoc291cmNlJDogT2JzZXJ2YWJsZTxUPikgPT4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgY29uc3QgdHJhY2VTdWJzY3JpcHRpb24gPSB0aGlzLnRyYWNlJChuYW1lLCBvcHRpb25zKS5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gc291cmNlJC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpLFxuICAgICAgICAoKSA9PiB7fSxcbiAgICAgICAgKCkgPT4gdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgICAgKVxuICAgICkuc3Vic2NyaWJlKHN1YnNjcmliZXIpO1xuICB9KTtcblxufVxuIl19