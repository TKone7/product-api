/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, NgZone, ApplicationRef, InjectionToken, Inject, Optional, PLATFORM_ID } from '@angular/core';
import { Observable, of, empty } from 'rxjs';
import { first, tap, map, shareReplay, switchMap } from 'rxjs/operators';
import { FirebaseApp, ÉµlazySDKProxy } from '@angular/fire';
import { isPlatformBrowser } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire";
// SEMVER @ v6, drop and move core ng metrics to a service
/** @type {?} */
export const AUTOMATICALLY_TRACE_CORE_NG_METRICS = new InjectionToken('angularfire2.performance.auto_trace');
/** @type {?} */
export const INSTRUMENTATION_ENABLED = new InjectionToken('angularfire2.performance.instrumentationEnabled');
/** @type {?} */
export const DATA_COLLECTION_ENABLED = new InjectionToken('angularfire2.performance.dataCollectionEnabled');
// WARNING: interface has both a type and a value, skipping emit
;
export class AngularFirePerformance {
    /**
     * @param {?} app
     * @param {?} automaticallyTraceCoreNgMetrics
     * @param {?} instrumentationEnabled
     * @param {?} dataCollectionEnabled
     * @param {?} appRef
     * @param {?} zone
     * @param {?} platformId
     */
    constructor(app, automaticallyTraceCoreNgMetrics, instrumentationEnabled, dataCollectionEnabled, appRef, zone, platformId) {
        this.zone = zone;
        this.trace$ = (/**
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        (name, options) => this.performance.pipe(switchMap((/**
         * @param {?} performance
         * @return {?}
         */
        performance => new Observable((/**
         * @param {?} emitter
         * @return {?}
         */
        emitter => this.zone.runOutsideAngular((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const trace = performance.trace(name);
            options && options.metrics && Object.keys(options.metrics).forEach((/**
             * @param {?} metric
             * @return {?}
             */
            metric => {
                trace.putMetric(metric, (/** @type {?} */ ((/** @type {?} */ (options)).metrics))[metric]);
            }));
            options && options.attributes && Object.keys(options.attributes).forEach((/**
             * @param {?} attribute
             * @return {?}
             */
            attribute => {
                trace.putAttribute(attribute, (/** @type {?} */ ((/** @type {?} */ (options)).attributes))[attribute]);
            }));
            /** @type {?} */
            const attributeSubscriptions = options && options.attribute$ ? Object.keys(options.attribute$).map((/**
             * @param {?} attribute
             * @return {?}
             */
            attribute => (/** @type {?} */ ((/** @type {?} */ (options)).attribute$))[attribute].subscribe((/**
             * @param {?} next
             * @return {?}
             */
            next => trace.putAttribute(attribute, next))))) : [];
            /** @type {?} */
            const metricSubscriptions = options && options.metric$ ? Object.keys(options.metric$).map((/**
             * @param {?} metric
             * @return {?}
             */
            metric => (/** @type {?} */ ((/** @type {?} */ (options)).metric$))[metric].subscribe((/**
             * @param {?} next
             * @return {?}
             */
            next => trace.putMetric(metric, next))))) : [];
            /** @type {?} */
            const incrementOnSubscriptions = options && options.incrementMetric$ ? Object.keys(options.incrementMetric$).map((/**
             * @param {?} metric
             * @return {?}
             */
            metric => (/** @type {?} */ ((/** @type {?} */ (options)).incrementMetric$))[metric].subscribe((/**
             * @param {?} next
             * @return {?}
             */
            next => trace.incrementMetric(metric, next || undefined))))) : [];
            emitter.next(trace.start());
            return { unsubscribe: (/**
                 * @return {?}
                 */
                () => {
                    trace.stop();
                    metricSubscriptions.forEach((/**
                     * @param {?} m
                     * @return {?}
                     */
                    m => m.unsubscribe()));
                    incrementOnSubscriptions.forEach((/**
                     * @param {?} m
                     * @return {?}
                     */
                    m => m.unsubscribe()));
                    attributeSubscriptions.forEach((/**
                     * @param {?} m
                     * @return {?}
                     */
                    m => m.unsubscribe()));
                }) };
        }))))))));
        this.traceUntil = (/**
         * @template T
         * @param {?} name
         * @param {?} test
         * @param {?=} options
         * @return {?}
         */
        (name, test, options) => (/**
         * @param {?} source$
         * @return {?}
         */
        (source$) => new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        subscriber => {
            /** @type {?} */
            const traceSubscription = this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @param {?} a
             * @return {?}
             */
            a => test(a) && traceSubscription.unsubscribe()), (/**
             * @return {?}
             */
            () => { }), (/**
             * @return {?}
             */
            () => options && options.orComplete && traceSubscription.unsubscribe()))).subscribe(subscriber);
        }))));
        this.traceWhile = (/**
         * @template T
         * @param {?} name
         * @param {?} test
         * @param {?=} options
         * @return {?}
         */
        (name, test, options) => (/**
         * @param {?} source$
         * @return {?}
         */
        (source$) => new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        subscriber => {
            /** @type {?} */
            let traceSubscription;
            return source$.pipe(tap((/**
             * @param {?} a
             * @return {?}
             */
            a => {
                if (test(a)) {
                    traceSubscription = traceSubscription || this.trace$(name, options).subscribe();
                }
                else {
                    traceSubscription && traceSubscription.unsubscribe();
                    traceSubscription = undefined;
                }
            }), (/**
             * @return {?}
             */
            () => { }), (/**
             * @return {?}
             */
            () => options && options.orComplete && traceSubscription && traceSubscription.unsubscribe()))).subscribe(subscriber);
        }))));
        this.traceUntilComplete = (/**
         * @template T
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        (name, options) => (/**
         * @param {?} source$
         * @return {?}
         */
        (source$) => new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        subscriber => {
            /** @type {?} */
            const traceSubscription = this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @return {?}
             */
            () => { }), (/**
             * @return {?}
             */
            () => { }), (/**
             * @return {?}
             */
            () => traceSubscription.unsubscribe()))).subscribe(subscriber);
        }))));
        this.traceUntilFirst = (/**
         * @template T
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        (name, options) => (/**
         * @param {?} source$
         * @return {?}
         */
        (source$) => new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        subscriber => {
            /** @type {?} */
            const traceSubscription = this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @return {?}
             */
            () => traceSubscription.unsubscribe()), (/**
             * @return {?}
             */
            () => { }), (/**
             * @return {?}
             */
            () => { }))).subscribe(subscriber);
        }))));
        this.trace = (/**
         * @template T
         * @param {?} name
         * @param {?=} options
         * @return {?}
         */
        (name, options) => (/**
         * @param {?} source$
         * @return {?}
         */
        (source$) => new Observable((/**
         * @param {?} subscriber
         * @return {?}
         */
        subscriber => {
            /** @type {?} */
            const traceSubscription = this.trace$(name, options).subscribe();
            return source$.pipe(tap((/**
             * @return {?}
             */
            () => traceSubscription.unsubscribe()), (/**
             * @return {?}
             */
            () => { }), (/**
             * @return {?}
             */
            () => traceSubscription.unsubscribe()))).subscribe(subscriber);
        }))));
        this.performance = of(undefined).pipe(switchMap((/**
         * @return {?}
         */
        () => isPlatformBrowser(platformId) ? zone.runOutsideAngular((/**
         * @return {?}
         */
        () => import('firebase/performance'))) : empty())), map((/**
         * @return {?}
         */
        () => zone.runOutsideAngular((/**
         * @return {?}
         */
        () => app.performance())))), tap((/**
         * @param {?} performance
         * @return {?}
         */
        performance => {
            if (instrumentationEnabled == false) {
                performance.instrumentationEnabled = false;
            }
            if (dataCollectionEnabled == false) {
                performance.dataCollectionEnabled = false;
            }
        })), shareReplay({ bufferSize: 1, refCount: false }));
        if (automaticallyTraceCoreNgMetrics != false) {
            // TODO determine more built in metrics
            // this leaks... move to a service?
            appRef.isStable.pipe(first((/**
             * @param {?} it
             * @return {?}
             */
            it => it)), this.traceUntilComplete('isStable')).subscribe();
        }
        return ÉµlazySDKProxy(this, this.performance, zone);
    }
}
AngularFirePerformance.decorators = [
    { type: Injectable, args: [{
                providedIn: 'any'
            },] }
];
/** @nocollapse */
AngularFirePerformance.ctorParameters = () => [
    { type: FirebaseApp },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [AUTOMATICALLY_TRACE_CORE_NG_METRICS,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [INSTRUMENTATION_ENABLED,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [DATA_COLLECTION_ENABLED,] }] },
    { type: ApplicationRef },
    { type: NgZone },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
/** @nocollapse */ AngularFirePerformance.Éµprov = i0.ÉµÉµdefineInjectable({ factory: function AngularFirePerformance_Factory() { return new AngularFirePerformance(i0.ÉµÉµinject(i1.FirebaseApp), i0.ÉµÉµinject(AUTOMATICALLY_TRACE_CORE_NG_METRICS, 8), i0.ÉµÉµinject(INSTRUMENTATION_ENABLED, 8), i0.ÉµÉµinject(DATA_COLLECTION_ENABLED, 8), i0.ÉµÉµinject(i0.ApplicationRef), i0.ÉµÉµinject(i0.NgZone), i0.ÉµÉµinject(i0.PLATFORM_ID)); }, token: AngularFirePerformance, providedIn: "any" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.performance;
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.trace$;
    /** @type {?} */
    AngularFirePerformance.prototype.traceUntil;
    /** @type {?} */
    AngularFirePerformance.prototype.traceWhile;
    /** @type {?} */
    AngularFirePerformance.prototype.traceUntilComplete;
    /** @type {?} */
    AngularFirePerformance.prototype.traceUntilFirst;
    /** @type {?} */
    AngularFirePerformance.prototype.trace;
    /**
     * @type {?}
     * @private
     */
    AngularFirePerformance.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyZm9ybWFuY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci9maXJlL3BlcmZvcm1hbmNlLyIsInNvdXJjZXMiOlsicGVyZm9ybWFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbEgsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpFLE9BQU8sRUFBRSxXQUFXLEVBQWlCLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7QUFHcEQsTUFBTSxPQUFPLG1DQUFtQyxHQUFHLElBQUksY0FBYyxDQUFVLHFDQUFxQyxDQUFDOztBQUNySCxNQUFNLE9BQU8sdUJBQXVCLEdBQUcsSUFBSSxjQUFjLENBQVUsaURBQWlELENBQUM7O0FBQ3JILE1BQU0sT0FBTyx1QkFBdUIsR0FBRyxJQUFJLGNBQWMsQ0FBVSxnREFBZ0QsQ0FBQzs7QUFFWixDQUFDO0FBYXpHLE1BQU0sT0FBTyxzQkFBc0I7Ozs7Ozs7Ozs7SUFJakMsWUFDRSxHQUFnQixFQUN5QywrQkFBNEMsRUFDeEQsc0JBQW1DLEVBQ25DLHFCQUFrQyxFQUMvRSxNQUFzQixFQUNkLElBQVksRUFDQyxVQUFpQjtRQUQ5QixTQUFJLEdBQUosSUFBSSxDQUFRO1FBNkJMLFdBQU07Ozs7O1FBQUcsQ0FBQyxJQUFXLEVBQUUsT0FBc0IsRUFBRSxFQUFFLENBQ2hFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUNuQixT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OztJQXFDbEUsd0NBK0JJOztJQUVKLDRDQVNHOztJQUVILDRDQWdCRzs7SUFFSCxvREFTRzs7SUFFSCxpREFTRzs7SUFFSCx1Q0FTRzs7Ozs7SUExSEQsc0NBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTmdab25lLCBBcHBsaWNhdGlvblJlZiwgSW5qZWN0aW9uVG9rZW4sIEluamVjdCwgT3B0aW9uYWwsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIG9mLCBlbXB0eSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlyc3QsIHRhcCwgbWFwLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgcGVyZm9ybWFuY2UgfSBmcm9tICdmaXJlYmFzZS9hcHAnO1xuaW1wb3J0IHsgRmlyZWJhc2VBcHAsIMm1UHJvbWlzZVByb3h5LCDJtWxhenlTREtQcm94eSB9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUnO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG4vLyBTRU1WRVIgQCB2NiwgZHJvcCBhbmQgbW92ZSBjb3JlIG5nIG1ldHJpY3MgdG8gYSBzZXJ2aWNlXG5leHBvcnQgY29uc3QgQVVUT01BVElDQUxMWV9UUkFDRV9DT1JFX05HX01FVFJJQ1MgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5wZXJmb3JtYW5jZS5hdXRvX3RyYWNlJyk7XG5leHBvcnQgY29uc3QgSU5TVFJVTUVOVEFUSU9OX0VOQUJMRUQgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5wZXJmb3JtYW5jZS5pbnN0cnVtZW50YXRpb25FbmFibGVkJyk7XG5leHBvcnQgY29uc3QgREFUQV9DT0xMRUNUSU9OX0VOQUJMRUQgPSBuZXcgSW5qZWN0aW9uVG9rZW48Ym9vbGVhbj4oJ2FuZ3VsYXJmaXJlMi5wZXJmb3JtYW5jZS5kYXRhQ29sbGVjdGlvbkVuYWJsZWQnKTtcblxuZXhwb3J0IGludGVyZmFjZSBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlIGV4dGVuZHMgT21pdDzJtVByb21pc2VQcm94eTxwZXJmb3JtYW5jZS5QZXJmb3JtYW5jZT4sICd0cmFjZSc+IHt9O1xuXG5leHBvcnQgdHlwZSBUcmFjZU9wdGlvbnMgPSB7XG4gIG1ldHJpY3M/OiB7W2tleTpzdHJpbmddOiBudW1iZXJ9LFxuICBhdHRyaWJ1dGVzPzoge1trZXk6c3RyaW5nXTpzdHJpbmd9LFxuICBhdHRyaWJ1dGUkPzoge1trZXk6c3RyaW5nXTpPYnNlcnZhYmxlPHN0cmluZz59LFxuICBpbmNyZW1lbnRNZXRyaWMkPzoge1trZXk6c3RyaW5nXTogT2JzZXJ2YWJsZTxudW1iZXJ8dm9pZHxudWxsfHVuZGVmaW5lZD59LFxuICBtZXRyaWMkPzoge1trZXk6c3RyaW5nXTogT2JzZXJ2YWJsZTxudW1iZXI+fVxufTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAnYW55J1xufSlcbmV4cG9ydCBjbGFzcyBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlIHtcbiAgXG4gIHByaXZhdGUgcmVhZG9ubHkgcGVyZm9ybWFuY2U6IE9ic2VydmFibGU8cGVyZm9ybWFuY2UuUGVyZm9ybWFuY2U+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogRmlyZWJhc2VBcHAsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChBVVRPTUFUSUNBTExZX1RSQUNFX0NPUkVfTkdfTUVUUklDUykgYXV0b21hdGljYWxseVRyYWNlQ29yZU5nTWV0cmljczpib29sZWFufG51bGwsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChJTlNUUlVNRU5UQVRJT05fRU5BQkxFRCkgaW5zdHJ1bWVudGF0aW9uRW5hYmxlZDpib29sZWFufG51bGwsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChEQVRBX0NPTExFQ1RJT05fRU5BQkxFRCkgZGF0YUNvbGxlY3Rpb25FbmFibGVkOmJvb2xlYW58bnVsbCxcbiAgICBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmLFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHBsYXRmb3JtSWQ6T2JqZWN0XG4gICkge1xuXG4gICAgdGhpcy5wZXJmb3JtYW5jZSA9IG9mKHVuZGVmaW5lZCkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiBpc1BsYXRmb3JtQnJvd3NlcihwbGF0Zm9ybUlkKSA/IHpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gaW1wb3J0KCdmaXJlYmFzZS9wZXJmb3JtYW5jZScpKSA6IGVtcHR5KCkpLFxuICAgICAgbWFwKCgpID0+IHpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gYXBwLnBlcmZvcm1hbmNlKCkpKSxcbiAgICAgIHRhcChwZXJmb3JtYW5jZSA9PiB7XG4gICAgICAgIGlmIChpbnN0cnVtZW50YXRpb25FbmFibGVkID09IGZhbHNlKSB7IHBlcmZvcm1hbmNlLmluc3RydW1lbnRhdGlvbkVuYWJsZWQgPSBmYWxzZSB9XG4gICAgICAgIGlmIChkYXRhQ29sbGVjdGlvbkVuYWJsZWQgPT0gZmFsc2UpIHsgcGVyZm9ybWFuY2UuZGF0YUNvbGxlY3Rpb25FbmFibGVkID0gZmFsc2UgfVxuICAgICAgfSksXG4gICAgICBzaGFyZVJlcGxheSh7IGJ1ZmZlclNpemU6IDEsIHJlZkNvdW50OiBmYWxzZSB9KSxcbiAgICApO1xuXG4gICAgaWYgKGF1dG9tYXRpY2FsbHlUcmFjZUNvcmVOZ01ldHJpY3MgIT0gZmFsc2UpIHtcblxuICAgICAgLy8gVE9ETyBkZXRlcm1pbmUgbW9yZSBidWlsdCBpbiBtZXRyaWNzXG4gICAgICAvLyB0aGlzIGxlYWtzLi4uIG1vdmUgdG8gYSBzZXJ2aWNlP1xuICAgICAgYXBwUmVmLmlzU3RhYmxlLnBpcGUoXG4gICAgICAgIGZpcnN0KGl0ID0+IGl0KSxcbiAgICAgICAgdGhpcy50cmFjZVVudGlsQ29tcGxldGUoJ2lzU3RhYmxlJylcbiAgICAgICkuc3Vic2NyaWJlKCk7XG5cbiAgICB9XG5cbiAgICByZXR1cm4gybVsYXp5U0RLUHJveHkodGhpcywgdGhpcy5wZXJmb3JtYW5jZSwgem9uZSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgdHJhY2UkID0gKG5hbWU6c3RyaW5nLCBvcHRpb25zPzogVHJhY2VPcHRpb25zKSA9PlxuICAgIHRoaXMucGVyZm9ybWFuY2UucGlwZShcbiAgICAgIHN3aXRjaE1hcChwZXJmb3JtYW5jZSA9PlxuICAgICAgICBuZXcgT2JzZXJ2YWJsZTx2b2lkPihlbWl0dGVyID0+XG4gICAgICAgICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRyYWNlID0gcGVyZm9ybWFuY2UudHJhY2UobmFtZSk7XG4gICAgICAgICAgICBvcHRpb25zICYmIG9wdGlvbnMubWV0cmljcyAmJiBPYmplY3Qua2V5cyhvcHRpb25zLm1ldHJpY3MpLmZvckVhY2gobWV0cmljID0+IHtcbiAgICAgICAgICAgICAgdHJhY2UucHV0TWV0cmljKG1ldHJpYywgb3B0aW9ucyEubWV0cmljcyFbbWV0cmljXSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgb3B0aW9ucyAmJiBvcHRpb25zLmF0dHJpYnV0ZXMgJiYgT2JqZWN0LmtleXMob3B0aW9ucy5hdHRyaWJ1dGVzKS5mb3JFYWNoKGF0dHJpYnV0ZSA9PiB7XG4gICAgICAgICAgICAgIHRyYWNlLnB1dEF0dHJpYnV0ZShhdHRyaWJ1dGUsIG9wdGlvbnMhLmF0dHJpYnV0ZXMhW2F0dHJpYnV0ZV0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVN1YnNjcmlwdGlvbnMgPSBvcHRpb25zICYmIG9wdGlvbnMuYXR0cmlidXRlJCA/IE9iamVjdC5rZXlzKG9wdGlvbnMuYXR0cmlidXRlJCkubWFwKGF0dHJpYnV0ZSA9PlxuICAgICAgICAgICAgICBvcHRpb25zIS5hdHRyaWJ1dGUkIVthdHRyaWJ1dGVdLnN1YnNjcmliZShuZXh0ID0+IHRyYWNlLnB1dEF0dHJpYnV0ZShhdHRyaWJ1dGUsIG5leHQpKVxuICAgICAgICAgICAgKSA6IFtdO1xuICAgICAgICAgICAgY29uc3QgbWV0cmljU3Vic2NyaXB0aW9ucyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5tZXRyaWMkID8gT2JqZWN0LmtleXMob3B0aW9ucy5tZXRyaWMkKS5tYXAobWV0cmljID0+XG4gICAgICAgICAgICAgIG9wdGlvbnMhLm1ldHJpYyQhW21ldHJpY10uc3Vic2NyaWJlKG5leHQgPT4gdHJhY2UucHV0TWV0cmljKG1ldHJpYywgbmV4dCkpXG4gICAgICAgICAgICApIDogW107XG4gICAgICAgICAgICBjb25zdCBpbmNyZW1lbnRPblN1YnNjcmlwdGlvbnMgPSBvcHRpb25zICYmIG9wdGlvbnMuaW5jcmVtZW50TWV0cmljJCA/IE9iamVjdC5rZXlzKG9wdGlvbnMuaW5jcmVtZW50TWV0cmljJCkubWFwKG1ldHJpYyA9PlxuICAgICAgICAgICAgICBvcHRpb25zIS5pbmNyZW1lbnRNZXRyaWMkIVttZXRyaWNdLnN1YnNjcmliZShuZXh0ID0+IHRyYWNlLmluY3JlbWVudE1ldHJpYyhtZXRyaWMsIG5leHQgfHwgdW5kZWZpbmVkKSlcbiAgICAgICAgICAgICkgOiBbXTtcbiAgICAgICAgICAgIGVtaXR0ZXIubmV4dCh0cmFjZS5zdGFydCgpKTtcbiAgICAgICAgICAgIHJldHVybiB7IHVuc3Vic2NyaWJlOiAoKSA9PiB7XG4gICAgICAgICAgICAgIHRyYWNlLnN0b3AoKTtcbiAgICAgICAgICAgICAgbWV0cmljU3Vic2NyaXB0aW9ucy5mb3JFYWNoKG0gPT4gbS51bnN1YnNjcmliZSgpKTtcbiAgICAgICAgICAgICAgaW5jcmVtZW50T25TdWJzY3JpcHRpb25zLmZvckVhY2gobSA9PiBtLnVuc3Vic2NyaWJlKCkpO1xuICAgICAgICAgICAgICBhdHRyaWJ1dGVTdWJzY3JpcHRpb25zLmZvckVhY2gobSA9PiBtLnVuc3Vic2NyaWJlKCkpO1xuICAgICAgICAgICAgfX07XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG5cbiAgcHVibGljIHJlYWRvbmx5IHRyYWNlVW50aWwgPSA8VD1hbnk+KG5hbWU6c3RyaW5nLCB0ZXN0OiAoYTpUKSA9PiBib29sZWFuLCBvcHRpb25zPzogVHJhY2VPcHRpb25zICYgeyBvckNvbXBsZXRlPzogYm9vbGVhbiB9KSA9PiAoc291cmNlJDogT2JzZXJ2YWJsZTxUPikgPT4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgY29uc3QgdHJhY2VTdWJzY3JpcHRpb24gPSB0aGlzLnRyYWNlJChuYW1lLCBvcHRpb25zKS5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gc291cmNlJC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICBhICA9PiB0ZXN0KGEpICYmIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCksXG4gICAgICAgICgpID0+IHt9LFxuICAgICAgICAoKSA9PiBvcHRpb25zICYmIG9wdGlvbnMub3JDb21wbGV0ZSAmJiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgICApXG4gICAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gIH0pO1xuXG4gIHB1YmxpYyByZWFkb25seSB0cmFjZVdoaWxlID0gPFQ9YW55PihuYW1lOnN0cmluZywgdGVzdDogKGE6VCkgPT4gYm9vbGVhbiwgb3B0aW9ucz86IFRyYWNlT3B0aW9ucyAmIHsgb3JDb21wbGV0ZT86IGJvb2xlYW59KSA9PiAoc291cmNlJDogT2JzZXJ2YWJsZTxUPikgPT4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgbGV0IHRyYWNlU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb258dW5kZWZpbmVkO1xuICAgIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgIGEgID0+IHtcbiAgICAgICAgICBpZiAodGVzdChhKSkge1xuICAgICAgICAgICAgdHJhY2VTdWJzY3JpcHRpb24gPSB0cmFjZVN1YnNjcmlwdGlvbiB8fCB0aGlzLnRyYWNlJChuYW1lLCBvcHRpb25zKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdHJhY2VTdWJzY3JpcHRpb24gJiYgdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIHRyYWNlU3Vic2NyaXB0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4ge30sXG4gICAgICAgICgpID0+IG9wdGlvbnMgJiYgb3B0aW9ucy5vckNvbXBsZXRlICYmIHRyYWNlU3Vic2NyaXB0aW9uICYmIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKClcbiAgICAgIClcbiAgICApLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgfSk7XG5cbiAgcHVibGljIHJlYWRvbmx5IHRyYWNlVW50aWxDb21wbGV0ZSA9IDxUPWFueT4obmFtZTpzdHJpbmcsIG9wdGlvbnM/OiBUcmFjZU9wdGlvbnMpID0+IChzb3VyY2UkOiBPYnNlcnZhYmxlPFQ+KSA9PiBuZXcgT2JzZXJ2YWJsZTxUPihzdWJzY3JpYmVyID0+IHtcbiAgICBjb25zdCB0cmFjZVN1YnNjcmlwdGlvbiA9IHRoaXMudHJhY2UkKG5hbWUsIG9wdGlvbnMpLnN1YnNjcmliZSgpO1xuICAgIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgICgpID0+IHt9LFxuICAgICAgICAoKSA9PiB7fSxcbiAgICAgICAgKCkgPT4gdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgICAgKVxuICAgICkuc3Vic2NyaWJlKHN1YnNjcmliZXIpO1xuICB9KTtcblxuICBwdWJsaWMgcmVhZG9ubHkgdHJhY2VVbnRpbEZpcnN0ID0gPFQ9YW55PihuYW1lOnN0cmluZywgb3B0aW9ucz86IFRyYWNlT3B0aW9ucykgPT4gKHNvdXJjZSQ6IE9ic2VydmFibGU8VD4pID0+IG5ldyBPYnNlcnZhYmxlPFQ+KHN1YnNjcmliZXIgPT4ge1xuICAgIGNvbnN0IHRyYWNlU3Vic2NyaXB0aW9uID0gdGhpcy50cmFjZSQobmFtZSwgb3B0aW9ucykuc3Vic2NyaWJlKCk7XG4gICAgcmV0dXJuIHNvdXJjZSQucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKCkgPT4gdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSxcbiAgICAgICAgKCkgPT4ge30sXG4gICAgICAgICgpID0+IHt9XG4gICAgICApXG4gICAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gIH0pO1xuXG4gIHB1YmxpYyByZWFkb25seSB0cmFjZSA9IDxUPWFueT4obmFtZTpzdHJpbmcsIG9wdGlvbnM/OiBUcmFjZU9wdGlvbnMpID0+IChzb3VyY2UkOiBPYnNlcnZhYmxlPFQ+KSA9PiBuZXcgT2JzZXJ2YWJsZTxUPihzdWJzY3JpYmVyID0+IHtcbiAgICBjb25zdCB0cmFjZVN1YnNjcmlwdGlvbiA9IHRoaXMudHJhY2UkKG5hbWUsIG9wdGlvbnMpLnN1YnNjcmliZSgpO1xuICAgIHJldHVybiBzb3VyY2UkLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgICgpID0+IHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCksXG4gICAgICAgICgpID0+IHt9LFxuICAgICAgICAoKSA9PiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgICApXG4gICAgKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gIH0pO1xuXG59XG4iXX0=